---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../consts';
import { getCollection } from 'astro:content';

const posts = (await getCollection('blog'))
    .filter((post) => post.id.startsWith('ja/'))
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
---

<!doctype html>
<html lang="ja">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
	</head>
	<body>
		<Header />
		<main>
			<h1>ğŸ” Game & AI Error Database</h1>
			<p>ComfyUIã€Unityã€Pythonã€AIé–‹ç™ºã®ã‚¨ãƒ©ãƒ¼ã¨è§£æ±ºç­–ã‚’AIãŒ24æ™‚é–“ä½“åˆ¶ã§åé›†ãƒ»ç¿»è¨³ã—ã¦ã„ã¾ã™ã€‚</p>
			
			<!-- Category Tabs -->
			<div class="category-tabs" style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;">
				{['All', 'ComfyUI', 'UnityML', 'Python', 'CivitAI', 'HuggingFace', 'ReactNative', 'Other'].map((cat) => (
					<button 
						class="filter-btn" 
						data-category={cat}
						style="padding: 6px 12px; border-radius: 20px; border: 1px solid #30363d; background: #0d1117; color: #8b949e; cursor: pointer; transition: all 0.2s;"
					>
						{cat === 'All' ? 'ã™ã¹ã¦' : cat}
					</button>
				))}
			</div>

			<div style="margin-bottom: 2rem;">
				<input type="text" id="search" placeholder="ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢..." style="width: 100%; padding: 10px; font-size: 16px; border-radius: 8px; border: 1px solid #30363d; background: #0d1117; color: white;">
			</div>

			<div id="article-list" style="margin-top: 2rem;">
				{posts.map((post) => {
					// Extract category from title ã€Categoryã€‘
					const match = post.data.title.match(/ã€(.*?)ã€‘/);
					let category = 'Other';
					if (match && match[1]) {
						// Normalize known categories if needed, but the generator output is consistent
						category = match[1];
					}
					
					return (
					<div 
						class="article-card" 
						data-title={post.data.title.toLowerCase()} 
						data-category={category}
						style="border: 1px solid #30363d; padding: 1rem; margin-bottom: 1rem; border-radius: 8px; background: #161b22;"
					>
						<a href={`/blog/${post.id}/`} style="text-decoration: none; color: inherit; display: block;">
							<h3 style="margin: 0; color: #58a6ff;">{post.data.title}</h3>
							<p style="margin: 0.5rem 0 0; font-size: 0.9rem; color: #8b949e;">
								{post.data.pubDate.toLocaleDateString('ja-JP')}
							</p>
						</a>
					</div>
				)})}
			</div>
		</main>
		<Footer />
		<script>
			const searchInput = document.getElementById('search');
			const filterBtns = document.querySelectorAll('.filter-btn');
			const articles = document.querySelectorAll('.article-card');

			let currentCategory = 'All';
			let currentSearch = '';

			function filterArticles() {
				articles.forEach(article => {
					const title = article.getAttribute('data-title');
					const category = article.getAttribute('data-category');
					
					// Category Match
					// Note: Generator uses 'UnityML' but user might want broader 'Unity'? 
					// For now strict match on shortname is safest as it matches the tabs.
					const matchesCategory = currentCategory === 'All' || category === currentCategory;
					
					// Search Match
					const matchesSearch = !currentSearch || (title && title.includes(currentSearch));

					if (matchesCategory && matchesSearch) {
						// @ts-ignore
						article.style.display = 'block';
					} else {
						// @ts-ignore
						article.style.display = 'none';
					}
				});
			}

			// Search Event
			if (searchInput) {
				searchInput.addEventListener('input', (e) => {
					// @ts-ignore
					currentSearch = e.target.value.toLowerCase();
					filterArticles();
				});
			}

			// Tab Event
			filterBtns.forEach(btn => {
				btn.addEventListener('click', () => {
					// Update Active State
					filterBtns.forEach(b => {
						// @ts-ignore
						b.style.background = '#0d1117';
						// @ts-ignore
						b.style.color = '#8b949e';
						// @ts-ignore
						b.style.borderColor = '#30363d';
					});
					// @ts-ignore
					btn.style.background = '#1f6feb';
					// @ts-ignore
					btn.style.color = 'white';
					// @ts-ignore
					btn.style.borderColor = '#1f6feb';

					const cat = btn.getAttribute('data-category');
					if (cat) {
						currentCategory = cat;
						filterArticles();
					}
				});
			});

			// Init with first tab active
			if(filterBtns.length > 0) {
				const first = filterBtns[0];
				// @ts-ignore
				first.style.background = '#1f6feb';
				// @ts-ignore
				first.style.color = 'white';
				// @ts-ignore
				first.style.borderColor = '#1f6feb';
			}
		</script>
	</body>
</html>
